const GF_RELX=1,GF_RELY=2,GF_RELW=4,GF_RELH=8;
var GAF_CLICKABLE=1,GAF_CONTEXTMENU=2,GAF_STRETCHABLE=4,GAF_DRAGGABLE_UPDOWN=8,GAF_DRAGGABLE_LEFTRIGHT=16,GAF_SWIPEABLE_UPDOWN=32,GAF_SWIPEABLE_LEFTRIGHT=64,GAF_SCROLLABLE_UPDOWN=128,GAF_SCROLLABLE_LEFTRIGHT=256,GAF_SCALABLE=512,GAF_ROTATABLE=1024,GAF_DRAGGABLE=GAF_DRAGGABLE_UPDOWN|GAF_DRAGGABLE_LEFTRIGHT,GAF_SWIPEABLE=GAF_SWIPEABLE_UPDOWN|GAF_SWIPEABLE_LEFTRIGHT,GAF_SCROLLABLE=GAF_SCROLLABLE_UPDOWN|GAF_SCROLLABLE_LEFTRIGHT,GAF_PINCHABLE=GAF_SCALABLE|GAF_ROTATABLE,GAF_ALL=GAF_CLICKABLE|GAF_CONTEXTMENU|
GAF_STRETCHABLE|GAF_DRAGGABLE|GAF_SCROLLABLE|GAF_PINCHABLE;
class Gadget{constructor(e){this.viewport=e;this.mat=mat4.create();mat4.identity(this.mat);this.hLimit=this.h=this.w=this.y=this.x=0;this.convexHull=[];this.extendedHulls={};this.boundingBoxes={};this.yo=this.xo=0;this.enabled=!0;this.actionFlags=0}getHits(e,a){if(this.enabled&&0!=this.convexHull.length){var b=this.viewport,d=vec3.create();mat4.getScaling(d,b.userMat);a=a/b.getScale()/d[0];d=""+a;d in this.extendedHulls||(this.computeExtendedHull(a),this.computeBoundingBox(a));a=this.extendedHulls[d];
var f=this.boundingBoxes[d];d=1/b.getScale();var c=vec3.create();c[0]=e.x-b.x;c[1]=e.y-b.y;var g=mat4.create();mat4.invert(g,b.userMat);vec3.transformMat4(c,c,g);b=c[0]*d;d*=c[1];if(!(b<f.x1||b>=f.x2||d<f.y1||d>=f.y2)){c=a.length;f=!0;for(g=0;g<c;g+=2){var k=a[g+0];var h=a[g+1];k=(a[(g+2)%c]-k)*(d-h)-(a[(g+3)%c]-h)*(b-k);0>k&&(f=!1)}if(f){c=this.convexHull.length;f=!0;for(g=0;g<c;g+=2)a=this.convexHull[g+0],k=this.convexHull[g+1],k=(this.convexHull[(g+2)%c]-a)*(d-k)-(this.convexHull[(g+3)%c]-k)*(b-
a),0>k&&(f=!1);a=0;f||(a=this.distToHull(b,d));e.hits.push({gad:this,dist:a})}}}}computeHull(e){function a(m,n,t,u,x,y){return(t-m)*(y-n)-(u-n)*(x-m)}function b(m){return m*m}function d(m,n,t,u,x,y){var w=b(t-x)+b(u-y);if(0==w)return b(m-t)+b(n-u);w=Math.max(0,Math.min(1,((m-t)*(x-t)+(n-u)*(y-u))/w));u+=w*(y-u);return b(m-(t+w*(x-t)))+b(n-u)}function f(m,n,t,u,x,y){if(!(2>n.length)){for(var w=0,z=0,r=0;r<~~(n.length/2);r++){var A=Math.sqrt(d(n[2*r],n[2*r+1],t,u,x,y));A>z&&(z=A,w=r)}z=n[2*w];A=n[2*
w+1];n.splice(2*w,2);for(r=0;r<~~(m.length/2);r++)if(m[2*r]==t&&m[2*r+1]==u&&m[(2*r+2)%m.length]==x&&m[(2*r+3)%m.length]==y||m[2*r]==x&&m[2*r+1]==y&&m[(2*r+2)%m.length]==t&&m[(2*r+3)%m.length]==u){m.splice(2*r+2,0,z,A);break}w=[];var B=[];for(r=0;r<~~(n.length/2);r++)0>a(t,u,z,A,n[2*r],n[2*r+1])&&(w[w.length]=n[2*r],w[w.length]=n[2*r+1]),0>a(z,A,x,y,n[2*r],n[2*r+1])&&(B[B.length]=n[2*r],B[B.length]=n[2*r+1]);f(m,w,t,u,z,A);f(m,B,z,A,x,y)}}for(var c=[...e],g=[],k=0,h=0,p=c[0],q=c[0],l=0;l<~~(c.length/
2);l++)c[2*l]<p&&(p=c[2*l],k=l),c[2*l]>q&&(q=c[2*l],h=l);g[g.length]=c[2*k];g[g.length]=c[2*k+1];g[g.length]=c[2*h];g[g.length]=c[2*h+1];c.splice(2*k,2);h<k?c.splice(2*h,2):c.splice(2*h-2,2);p=[];q=[];for(l=0;l<~~(c.length/2);l++)0>a(e[2*k],e[2*k+1],e[2*h],e[2*h+1],c[2*l],c[2*l+1])?(p[p.length]=c[2*l],p[p.length]=c[2*l+1]):(q[q.length]=c[2*l],q[q.length]=c[2*l+1]);f(g,p,e[2*k],e[2*k+1],e[2*h],e[2*h+1]);f(g,q,e[2*h],e[2*h+1],e[2*k],e[2*k+1]);for(e=1;e;)for(l=e=0;l<~~(g.length/2);l++)if(.01>Math.sqrt(d(g[(2*
l+2)%g.length],g[(2*l+3)%g.length],g[2*l],g[2*l+1],g[(2*l+4)%g.length],g[(2*l+5)%g.length]))){g.splice(2*l+2,2);e=1;break}return this.sortHull(g)}sortHull(e){function a(q){for(q=Math.atan2(e[q+1]-f,e[q+0]-d)-Math.atan2(h-f,k-d);q>Math.PI;)q-=2*Math.PI;for(;q<-Math.PI;)q+=2*Math.PI;return q}for(var b=[],d=0,f=0,c=e.length,g=0;g<c;g+=2)d+=e[g+0],f+=e[g+1];d/=c/2;f/=c/2;for(var k=d+102,h=f+1;0<e.length;){c=0;var p=a(0);for(g=0;g<e.length;g+=2)a(g)<p&&(c=g,p=a(g));b.push(e[c+0]);b.push(e[c+1]);e.splice(c,
2)}return b}computeExtendedHull(e){for(var a=[],b=0,d=this.convexHull.length,f=0;f<d;f+=2){var c=this.convexHull[(f+3)%d]-this.convexHull[f+1],g=-(this.convexHull[(f+2)%d]-this.convexHull[f+0]),k=e/Math.sqrt(c*c+g*g);a[b+0]=this.convexHull[f+0]+c*k;a[b+1]=this.convexHull[f+1]+g*k;b+=2;a[b+0]=this.convexHull[(f+2)%d]+c*k;a[b+1]=this.convexHull[(f+3)%d]+g*k;b+=2}for(f=0;f<d;f+=2){c=this.convexHull[(f+2)%d]-this.convexHull[f+0];g=this.convexHull[(f+3)%d]-this.convexHull[f+1];b=this.convexHull[(f-2+d)%
d]-this.convexHull[f+0];var h=this.convexHull[(f-1+d)%d]-this.convexHull[f+1];k=Math.sqrt(c*c+g*g);h=Math.tan((Math.PI-Math.acos((c*b+g*h)/(k*Math.sqrt(b*b+h*h))))/4)*e;b=2*f;c=a[b+0]-a[b+2];g=a[b+1]-a[b+3];k=Math.sqrt(c*c+g*g);c=c*(k+h)/k;g=g*(k+h)/k;a[b+0]=c+a[b+2];a[b+1]=g+a[b+3];b=(f-2+d)%d*2;c=a[b+2]-a[b+0];g=a[b+3]-a[b+1];k=Math.sqrt(c*c+g*g);c=c*(k+h)/k;g=g*(k+h)/k;a[b+2]=c+a[b+0];a[b+3]=g+a[b+1]}this.extendedHulls[""+e]=a}computeBoundingBox(e){this.boundingBoxes[""+e]={};var a=this.extendedHulls[""+
e];e=this.boundingBoxes[""+e];if(!(2>a.length)){e.x1=a[0];e.x2=a[0];e.y1=a[1];e.y2=a[1];for(var b=2;b<a.length;b+=2)a[b+0]<e.x1&&(e.x1=a[b+0]),a[b+0]>e.x2&&(e.x2=a[b+0]),a[b+1]<e.y1&&(e.y1=a[b+1]),a[b+1]>e.y2&&(e.y2=a[b+1])}}distToHull(e,a){function b(h){return h*h}function d(h,p,q,l,m,n){var t=b(q-m)+b(l-n);if(0==t)return b(h-q)+b(p-l);t=Math.max(0,Math.min(1,((h-q)*(m-q)+(p-l)*(n-l))/t));l+=t*(n-l);return b(h-(q+t*(m-q)))+b(p-l)}for(var f=this.convexHull,c=Math.sqrt(d(e,a,f[0],f[1],f[2],f[3])),
g=2;g<f.length;g+=2){var k=Math.sqrt(d(e,a,f[g+0],f[g+1],f[(g+2)%f.length],f[(g+3)%f.length]));k<c&&(c=k)}return c}}
class MiddleDividerGadget extends Gadget{constructor(e){super(e);this.dragBeginFunc=function(a){this.tempX=a.ox-this.viewport.x;this.tempY=a.oy-this.viewport.y};this.dragMoveFunc=function(a){var b=this.viewport.parent,d="h"==b.state,f=d?a.y-this.tempY-b.a.y:a.x-this.tempX-b.a.x;b.ratio=Math.max(0,Math.min(1,f/(f+(d?b.y+b.h-(a.y-this.tempY+this.viewport.h):b.x+b.w-(a.x-this.tempX+this.viewport.w)))));this.viewport.parent.relayout()};this.dragEndFunc=function(a){delete this.tempX;delete this.tempY}}layout(){var e=
this.viewport,a="h"==e.parent.state,b=e.getScale(),d=e.parent.size;var f=a?e.w/b:d;e=a?d:e.h/b;this.actionFlags=a?vp.GAF_DRAGGABLE_UPDOWN:vp.GAF_DRAGGABLE_LEFTRIGHT;this.convexHull=this.computeHull([0,0,0,e,f,e,f,0]);this.extendedHulls={};this.boundingBoxes={}}}
class MatrixGadget extends Gadget{getTargetMat(){return this.targetGad?this.targetGad.mat:this.targetView.userMat}constructor(e){super(e);this.targetView=e;this.targetGad=void 0;this.dragBeginFunc=function(a){var b=this.targetView;this.grab1b=vec3.create();this.grab1b[0]=a.x-b.x;this.grab1b[1]=a.y-b.y;this.viewMat=mat4.create();mat4.copy(this.viewMat,b.userMat);this.grabMat=mat4.create();mat4.copy(this.grabMat,this.getTargetMat());a=mat4.create();mat4.invert(a,this.viewMat);vec3.transformMat4(this.grab1b,
this.grab1b,a);this.targetGad&&(a=mat4.create(),mat4.invert(a,this.grabMat),vec3.transformMat4(this.grab1b,this.grab1b,a))};this.dragMoveFunc=function(a){var b=this.targetView,d=vec3.create();d[0]=a.x-b.x;d[1]=a.y-b.y;a=mat4.create();mat4.invert(a,this.viewMat);vec3.transformMat4(d,d,a);this.targetGad&&(a=mat4.create(),mat4.invert(a,this.grabMat),vec3.transformMat4(d,d,a));a=vec3.create();vec3.subtract(a,d,this.grab1b);this.targetGad&&vec3.scale(a,a,1/b.getScale());mat4.translate(this.getTargetMat(),
this.grabMat,a);b.rematrix();b.setRenderFlag(!0)};this.dragEndFunc=function(a){a=this.targetView;delete this.grab1b;delete this.viewMat;delete this.grabMat;a.setRenderFlag(!0)};this.pinchBeginFunc=function(a,b){var d=this.targetView;this.grab1=vec3.create();this.grab1[0]=a.x-d.x;this.grab1[1]=a.y-d.y;this.grab2=vec3.create();this.grab2[0]=b.x-d.x;this.grab2[1]=b.y-d.y;this.viewMat=mat4.create();mat4.copy(this.viewMat,d.userMat);this.grabMat=mat4.create();mat4.copy(this.grabMat,this.getTargetMat());
this.grabC=vec3.create();this.grab1b=vec3.create();vec3.copy(this.grab1b,this.grab1);this.grab2b=vec3.create();vec3.copy(this.grab2b,this.grab2);this.grabCb=vec3.create();a=mat4.create();mat4.invert(a,this.viewMat);vec3.transformMat4(this.grab1b,this.grab1b,a);vec3.transformMat4(this.grab2b,this.grab2b,a);this.targetGad&&(a=mat4.create(),mat4.copy(a,this.grabMat),vec3.transformMat4(this.grab1b,this.grab1b,a),vec3.transformMat4(this.grab2b,this.grab2b,a));for(a=0;3>a;a++)this.grabC[a]=(this.grab1[a]+
this.grab2[a])/2,this.grabCb[a]=(this.grab1b[a]+this.grab2b[a])/2;a=this.grab2[0]-this.grab1[0];b=this.grab2[1]-this.grab1[1];this.grabA=Math.atan2(b,a);this.grabM=Math.sqrt(a*a+b*b)};this.pinchMoveFunc=function(a,b){var d=this.targetView,f=vec3.create();f[0]=a.x-d.x;f[1]=a.y-d.y;a=vec3.create();a[0]=b.x-d.x;a[1]=b.y-d.y;var c=vec3.create(),g=vec3.create(),k=vec3.create();b=vec3.create();vec3.copy(g,f);vec3.copy(k,a);var h=mat4.create();mat4.invert(h,this.viewMat);vec3.transformMat4(g,g,h);vec3.transformMat4(k,
k,h);this.targetGad&&(h=mat4.create(),mat4.copy(h,this.grabMat),vec3.transformMat4(g,g,h),vec3.transformMat4(k,k,h));for(h=0;3>h;h++)c[h]=(f[h]+a[h])/2,b[h]=(g[h]+k[h])/2;c=a[0]-f[0];a=a[1]-f[1];f=Math.atan2(a,c);a=Math.sqrt(c*c+a*a);c=mat4.create();mat4.copy(c,this.grabMat);this.targetGad?(this.actionFlags&vp.GAF_DRAGGABLE?mat4.translate(c,c,[b[0]/d.getScale(),b[1]/d.getScale(),0]):mat4.translate(c,c,[this.grabCb[0]/d.getScale(),this.grabCb[1]/d.getScale(),0]),this.actionFlags&vp.GAF_SCALABLE&&mat4.scale(c,
c,[a/this.grabM,a/this.grabM,1]),this.actionFlags&vp.GAF_ROTATABLE&&mat4.rotate(c,c,f-this.grabA,[0,0,1]),mat4.translate(c,c,[-this.grabCb[0]/d.getScale(),-this.grabCb[1]/d.getScale(),0])):(this.actionFlags&vp.GAF_DRAGGABLE?mat4.translate(c,c,[b[0],b[1],0]):mat4.translate(c,c,[this.grabCb[0],this.grabCb[1],0]),this.actionFlags&vp.GAF_SCALABLE&&mat4.scale(c,c,[a/this.grabM,a/this.grabM,1]),this.actionFlags&vp.GAF_ROTATABLE&&mat4.rotate(c,c,f-this.grabA,[0,0,1]),mat4.translate(c,c,[-this.grabCb[0],
-this.grabCb[1],0]));d.rematrix();d.setRenderFlag(!0);mat4.copy(this.getTargetMat(),c)};this.pinchEndFunc=function(a,b){delete this.grab1;delete this.grab1b;delete this.grab2;delete this.grab2b;delete this.grabC;delete this.grabCb;delete this.grabA;delete this.grabM;delete this.grabMat};this.zoomFunc=function(a,b){const d=this.targetView,f=this.getTargetMat(),c=vec3.create();this.actionFlags&vp.GAF_DRAGGABLE?(c[0]=a.x-d.x,c[1]=a.y-d.y):mat4.getTranslation(c,f);a=mat4.create();mat4.invert(a,f);vec3.transformMat4(c,
c,a);mat4.translate(f,f,[c[0],c[1],0]);mat4.scale(f,f,[Math.exp(b/10),Math.exp(b/10),1]);mat4.translate(f,f,[-c[0],-c[1],0]);d.rematrix();d.setRenderFlag(!0)};this.rotateFunc=function(a,b){const d=this.targetView,f=this.getTargetMat(),c=vec3.create();this.actionFlags&vp.GAF_DRAGGABLE?(c[0]=a.x-d.x,c[1]=a.y-d.y):mat4.getTranslation(c,f);a=mat4.create();mat4.invert(a,f);vec3.transformMat4(c,c,a);mat4.translate(f,f,[c[0],c[1],0]);mat4.rotate(f,f,-Math.PI/18*b,[0,0,1]);mat4.translate(f,f,[-c[0],-c[1],
0]);d.rematrix();d.setRenderFlag(!0)}}getHits(e,a){this.enabled&&(0==this.convexHull.length?e.hits.push({gad:this,dist:0}):super.getHits(e,a))}layout(){v=this.viewport;console.log("MatrixGadget::layout()")}}
class SwipeGadget extends Gadget{constructor(e){super(e);this.actionFlags=vp.GAF_SWIPEABLE_UPDOWN|vp.GAF_SCROLLABLE_UPDOWN;this.swipeBeginFunc=function(a){var b=this.viewport,d=b.getScale();this.tempX=(a.ox-b.x-b.ox)/d+b.userX;this.tempY=(a.oy-b.y-b.oy)/d+b.userY};this.swipeMoveFunc=function(a){var b=this.viewport,d=b.getScale(),f=Math.max(b.minX+b.w/d,b.maxX)-b.w/d,c=Math.min(b.maxX-b.w/d,b.minX),g=Math.max(b.minY+b.h/d,b.maxY)-b.h/d,k=Math.min(b.maxY-b.h/d,b.minY);if(c<f){var h=f;f=c;c=h}k<g&&(h=
g,g=k,k=h);switch(this.actionFlags&vp.GAF_SWIPEABLE){case vp.GAF_SWIPEABLE_UPDOWN:var p=(a.y-b.y-b.oy)/d+b.userY-this.tempY;b.userY=Math.min(k,Math.max(g,b.userY-p-b.oy/d))+b.oy/d;b.rematrix();this.layout();b.tempVX=0;b.tempVY=a.dy;break;case vp.GAF_SWIPEABLE_LEFTRIGHT:h=(a.x-b.x-b.ox)/d+b.userX-this.tempX;b.userX=Math.min(c,Math.max(f,b.userX-h-b.ox/d))+b.ox/d;b.rematrix();this.layout();b.tempVX=a.dx;b.tempVY=0;break;case vp.GAF_SWIPEABLE_UPDOWN|vp.GAF_SWIPEABLE_LEFTRIGHT:h=(a.x-b.x-b.ox)/d+b.userX-
this.tempX,p=(a.y-b.y-b.oy)/d+b.userY-this.tempY,b.userX=Math.min(c,Math.max(f,b.userX-h-b.ox/d))+b.ox/d,b.userY=Math.min(k,Math.max(g,b.userY-p-b.oy/d))+b.oy/d,b.rematrix(),this.layout(),b.tempVX=a.dx,b.tempVY=a.dy}};this.swipeEndFunc=function(a){function b(k,h){var p=c.getScale(),q=k[0];k=k[1];var l=h[0];h=h[1];var m=Math.sqrt(l*l+h*h);var n=Math.floor(10*m);var t=(10*m-n)/10,u=(n+1)*n/2;0<m&&(q-=l/m*(u/10+t*n)*1E3/30/p,k-=h/m*(u/10+t*n)*1E3/30/p);return[q,k]}function d(k,h){var p="unset",q;if(h)for(q of h)if(h=
Math.sqrt((k[0]-q[0])**2+(k[1]-q[1])**2),"unset"==p||h<p){p=h;var l=q}return l}function f(k,h){var p=h.getScale(),q=Math.max(h.minX+h.w/p,h.maxX)-h.w/p,l=Math.min(h.maxX-h.w/p,h.minX),m=Math.max(h.minY+h.h/p,h.maxY)-h.h/p,n=Math.min(h.maxY-h.h/p,h.minY);if(l<q){var t=q;q=l;l=t}n<m&&(t=m,m=n,n=t);return k[0]-h.ox/p<q||k[0]-h.ox/p>l||k[1]-h.oy/p<m||k[1]-h.oy/p>n}var c=this.viewport;delete this.tempX;delete this.tempY;c.tempDX=0;c.tempDY=0;if(c.snaps&&0<c.snaps.length){a=b([c.userX,c.userY],[c.tempVX,
c.tempVY]);var g=d(a,c.snaps);f(a,c)||(c.tempDX=g[0]-a[0],c.tempDY=g[1]-a[1])}animViews.includes(c)||animViews.push(c);c.setRenderFlag(!0)}}layout(){var e=this.viewport,a=e.getScale();this.convexHull=this.computeHull([e.userX-e.ox/a,e.userY-e.oy/a,e.userX-e.ox/a,e.h/a+e.userY-e.oy/a,e.w/a+e.userX-e.ox/a,e.h/a+e.userY-e.oy/a,e.w/a+e.userX-e.ox/a,e.userY-e.oy/a]);this.extendedHulls={};this.boundingBoxes={}}};
